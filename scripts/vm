#!/bin/bash
# VM Management Dispatcher - Main entry point for all VM operations
# Usage: vm <command> [args...]

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the shared VM detection library
source "$SCRIPT_DIR/lib/vm-detect.sh"

# Color codes
COLOR_RESET='\033[0m'
COLOR_INFO='\033[36m'
COLOR_SUCCESS='\033[32m'
COLOR_ERROR='\033[31m'
COLOR_WARN='\033[33m'

show_help() {
    printf "${COLOR_INFO}VM Management Commands${COLOR_RESET}\n"
    printf "\n"
    printf "${COLOR_SUCCESS}Usage:${COLOR_RESET} vm <command> [args...]\n"
    printf "\n"
    printf "${COLOR_SUCCESS}Setup & Configuration:${COLOR_RESET}\n"
    printf "  ${COLOR_INFO}setup${COLOR_RESET} [options]     - Initial VM setup and configuration\n"
    printf "  ${COLOR_INFO}profile${COLOR_RESET} <action>    - Manage VM profiles (list, switch, info, delete)\n"
    printf "\n"
    printf "${COLOR_SUCCESS}Development:${COLOR_RESET}\n"
    printf "  ${COLOR_INFO}dev${COLOR_RESET}               - Deploy extension to VM (lint + compile + reload)\n"
    printf "  ${COLOR_INFO}logs${COLOR_RESET}              - Watch extension logs from VM\n"
    printf "\n"
    printf "${COLOR_SUCCESS}VM Control:${COLOR_RESET}\n"
    printf "  ${COLOR_INFO}headless${COLOR_RESET} <action>  - Headless mode operations (start, stop, status, display)\n"
    printf "  ${COLOR_INFO}start${COLOR_RESET} [vmname]     - Start VM with display\n"
    printf "\n"
    printf "${COLOR_SUCCESS}Utilities:${COLOR_RESET}\n"
    printf "  ${COLOR_INFO}optimize${COLOR_RESET}          - Apply VirtIO optimizations to VM config\n"
    printf "  ${COLOR_INFO}network${COLOR_RESET}           - Configure host networking\n"
    printf "\n"
    printf "${COLOR_SUCCESS}Examples:${COLOR_RESET}\n"
    printf "  vm setup              - Run initial VM setup\n"
    printf "  vm profile list       - List all VM profiles\n"
    printf "  vm logs               - Watch VM logs\n"
    printf "  vm headless start     - Start VM without display\n"
    printf "\n"
    printf "${COLOR_INFO}For testing, use:${COLOR_RESET} ./scripts/run-tests mem --preset quick\n"
    printf "\n"
    printf "${COLOR_INFO}Tip:${COLOR_RESET} Use 'direnv' or add an alias in .zshrc:\n"
    printf "  alias vm='./scripts/vm'\n"
    printf "\n"
}

# Parse command
COMMAND="${1:-}"
shift 2>/dev/null || true

case "$COMMAND" in
    # Setup & Configuration
    setup)
        exec "$SCRIPT_DIR/user/vm-setup" "$@"
        ;;
    
    profile)
        exec "$SCRIPT_DIR/user/vm-profile" "$@"
        ;;
    
    # Install dev build
    install)
        exec "$SCRIPT_DIR/user/vm-install" "$@"
        ;;
    
    logs)
        exec "$SCRIPT_DIR/user/vm-logs" "$@"
        ;;
    
    # VM Control
    headless)
        exec "$SCRIPT_DIR/user/vm-headless" "$@"
        ;;
    
    start)
        # This would need to be implemented or use headless start
        printf "${COLOR_WARN}Use 'vm headless start' or run via Make: make vm-start${COLOR_RESET}\n"
        exit 1
        ;;
    
    
    # Utilities
    optimize)
        # Use system Python explicitly - libvirt-python is a system package
        exec /usr/bin/python3 "$SCRIPT_DIR/util/vm-optimize.py" "$@"
        ;;
    
    network)
        exec "$SCRIPT_DIR/util/vm-network-setup" "$@"
        ;;
    
    # Help
    help|--help|-h|"")
        show_help
        exit 0
        ;;
    
    # Unknown command
    *)
        printf "${COLOR_ERROR}Unknown command: $COMMAND${COLOR_RESET}\n\n"
        show_help
        exit 1
        ;;
esac