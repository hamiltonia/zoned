#!/bin/bash
#
# vm-restart-spice - Restart SPICE display services in VM
#
# Use this when SPICE client connection fails after a VM reboot.
# This is a common issue where the spice-vdagentd service doesn't
# start properly on boot.
#
# Uses auto-detection to find running VM (no config file needed).
#
# Usage: make vm-restart-spice
#

set -e

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the shared VM detection library
source "$SCRIPT_DIR/../lib/vm-detect.sh"

# ============================================
#  MAIN
# ============================================

main() {
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   Restarting SPICE Services${NC}"
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Detect running VM
    local running_vms
    running_vms=$(vm_get_running)
    
    if [[ -z "$running_vms" ]]; then
        vm_print_error "No VMs are currently running"
        echo ""
        echo "Start a VM first, then run this command again."
        exit 1
    fi
    
    # Count running VMs
    local count
    count=$(echo "$running_vms" | wc -l)
    
    if [[ $count -eq 1 ]]; then
        VM_DOMAIN="$running_vms"
        vm_print_info "Detected VM: $VM_DOMAIN"
    else
        # Multiple VMs - prompt to select
        echo -e "${CYAN}Multiple VMs are running:${NC}"
        echo ""
        
        local vms=()
        local i=1
        while IFS= read -r vm; do
            [[ -z "$vm" ]] && continue
            local title=$(vm_get_title "$vm")
            echo "  $i) $vm - \"$title\""
            vms+=("$vm")
            ((i++))
        done <<< "$running_vms"
        
        echo ""
        read -p "Select VM [1-${#vms[@]}]: " selection
        
        if [[ ! "$selection" =~ ^[0-9]+$ ]] || [[ $selection -lt 1 ]] || [[ $selection -gt ${#vms[@]} ]]; then
            vm_print_error "Invalid selection"
            exit 1
        fi
        
        VM_DOMAIN="${vms[$((selection-1))]}"
    fi
    
    echo ""
    
    # Test SSH connection first
    vm_print_step "Testing SSH connection..."
    echo -e "${YELLOW}  [VM]${NC} Testing connection..."
    if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$VM_DOMAIN" "exit" 2>/dev/null; then
        vm_print_error "Cannot connect to VM: $VM_DOMAIN"
        echo ""
        echo "Possible causes:"
        echo "  • SSH server not running in VM"
        echo "  • SSH keys not set up"
        echo ""
        echo "Run 'make vm-install' first to set up SSH access."
        exit 1
    fi
    vm_print_success "SSH connection OK"
    echo ""
    
    # Restart SPICE services
    vm_print_step "Restarting SPICE services..."
    echo ""
    
    # Check if passwordless sudo is available
    echo -e "${YELLOW}  [VM]${NC} Checking sudo configuration..."
    local sudo_nopass
    sudo_nopass=$(ssh "$VM_DOMAIN" "sudo -n true 2>/dev/null && echo yes || echo no")
    
    # Restart spice-vdagentd (system service - this is the main one)
    echo -ne "${YELLOW}  [VM]${NC} spice-vdagentd (system): "
    if [[ "$sudo_nopass" == "yes" ]]; then
        # Passwordless sudo available
        if ssh "$VM_DOMAIN" "sudo systemctl restart spice-vdagentd" 2>/dev/null; then
            echo -e "${GREEN}restarted${NC}"
        else
            echo -e "${YELLOW}not found${NC}"
        fi
    else
        # Need password - use -t for TTY allocation
        echo -e "${YELLOW}(sudo password required)${NC}"
        echo -e "${YELLOW}  [VM]${NC} Restarting with sudo prompt..."
        ssh -t "$VM_DOMAIN" "sudo systemctl restart spice-vdagentd" 2>/dev/null || true
        echo -e "${YELLOW}  [VM]${NC} spice-vdagentd (system): ${GREEN}restarted${NC}"
    fi
    
    # Restart spice-vdagent (user service - if it exists)
    echo -ne "${YELLOW}  [VM]${NC} spice-vdagent (user):    "
    if ssh "$VM_DOMAIN" "systemctl --user restart spice-vdagent" 2>/dev/null; then
        echo -e "${GREEN}restarted${NC}"
    else
        echo -e "${YELLOW}not found (OK)${NC}"
    fi
    
    # Restart spice-webdavd (for shared folders)
    echo -ne "${YELLOW}  [VM]${NC} spice-webdavd (user):    "
    if ssh "$VM_DOMAIN" "systemctl --user restart spice-webdavd" 2>/dev/null; then
        echo -e "${GREEN}restarted${NC}"
    else
        echo -e "${YELLOW}not found${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}✓ SPICE services restarted${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Try reconnecting with GNOME Boxes now."
    echo "If it still doesn't work, try closing and reopening the VM window."
    echo ""
}

main "$@"
