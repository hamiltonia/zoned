#!/bin/bash
#
# vm-install - Install/update extension in VM
#
# Useful during development to:
# - Ensure latest code is visible in VM
# - Compile schema if needed
# - Reload GNOME Shell (on X11)
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

CONFIG_FILE="$HOME/.config/zoned-dev/config"

# Load configuration
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}✗ Configuration file not found: $CONFIG_FILE${NC}"
    echo
    echo "Run 'make vm-init' first to create the configuration."
    exit 1
fi

source "$CONFIG_FILE"

echo -e "${BLUE}Installing Zoned extension to VM...${NC}"

# Test SSH connection
if ! ssh -o ConnectTimeout=5 "$VM_USER@$VM_IP" "exit" 2>/dev/null; then
    echo -e "${RED}✗ Cannot connect to VM${NC}"
    echo "Make sure the VM is running and SSH is configured."
    exit 1
fi

# Detect mount point (check legacy path first, then GVFS)
if ssh "$VM_USER@$VM_IP" "test -d $VM_SPICE_MOUNT" 2>/dev/null; then
    ACTUAL_MOUNT="$VM_SPICE_MOUNT"
else
    # Search for both dav: and dav+sd: protocols
    GVFS_MOUNT=$(ssh "$VM_USER@$VM_IP" "find /run/user/1000/gvfs -maxdepth 1 -name 'dav*:*' -type d 2>/dev/null | head -n1" || echo "")
    if [ -z "$GVFS_MOUNT" ]; then
        echo -e "${RED}✗ Shared folder not mounted in VM${NC}"
        echo "Mount it in VM: Nautilus → Other Locations → Networks → Spice client folder"
        echo "Then run 'make vm-setup' again"
        exit 1
    fi
    
    # Check if the mount has a subdirectory matching the share name
    if ssh "$VM_USER@$VM_IP" "test -d $GVFS_MOUNT/zoned" 2>/dev/null; then
        ACTUAL_MOUNT="$GVFS_MOUNT/zoned"
    else
        ACTUAL_MOUNT="$GVFS_MOUNT"
    fi
fi

# Verify extension exists in shared folder
if ! ssh "$VM_USER@$VM_IP" "test -f $ACTUAL_MOUNT/extension/metadata.json" 2>/dev/null; then
    echo -e "${RED}✗ Extension not found in shared folder${NC}"
    echo "Expected: $ACTUAL_MOUNT/extension/"
    exit 1
fi

# Compile schema if it exists
if ssh "$VM_USER@$VM_IP" "test -d ~/.local/share/gnome-shell/extensions/$EXTENSION_UUID/schemas" 2>/dev/null; then
    echo -e "${BLUE}Compiling GSettings schema...${NC}"
    ssh "$VM_USER@$VM_IP" "glib-compile-schemas ~/.local/share/gnome-shell/extensions/$EXTENSION_UUID/schemas/"
    echo -e "${GREEN}✓ Schema compiled${NC}"
fi

# Check if extension is enabled (ACTIVE = running, INACTIVE = enabled but needs shell restart)
# Note: gnome-extensions info output has leading whitespace (e.g., "  State: ACTIVE")
EXT_STATE=$(ssh "$VM_USER@$VM_IP" "gnome-extensions info $EXTENSION_UUID 2>/dev/null | grep 'State:'" 2>/dev/null || echo "State: UNKNOWN")
if echo "$EXT_STATE" | grep -qE 'State:\s*(ACTIVE|INACTIVE)'; then
    EXTENSION_ENABLED=true
else
    EXTENSION_ENABLED=false
    echo -e "${YELLOW}⚠ Extension is not enabled${NC}"
    echo "Enabling extension..."
    ssh "$VM_USER@$VM_IP" "gnome-extensions enable $EXTENSION_UUID"
fi

# Try to reload GNOME Shell (only works on X11)
# Note: $XDG_SESSION_TYPE isn't available over SSH, so use loginctl instead
# We need to find the graphical session (x11/wayland), not the SSH session (unspecified)
SESSION_TYPE=$(ssh "$VM_USER@$VM_IP" "
    for sid in \$(loginctl --no-legend | awk '{print \$1}'); do
        type=\$(loginctl show-session \$sid -p Type --value 2>/dev/null)
        if [ \"\$type\" = 'x11' ] || [ \"\$type\" = 'wayland' ]; then
            echo \$type
            break
        fi
    done
" 2>/dev/null || echo "")
[ -z "$SESSION_TYPE" ] && SESSION_TYPE="unknown"

echo
if [ "$SESSION_TYPE" = "x11" ]; then
    echo -e "${BLUE}Detected X11 session - attempting to reload GNOME Shell...${NC}"
    if ssh "$VM_USER@$VM_IP" "gdbus call --session --dest org.gnome.Shell --object-path /org/gnome/Shell --method org.gnome.Shell.Eval 'Meta.restart(\"Restarting…\")' > /dev/null 2>&1"; then
        echo -e "${GREEN}✓ GNOME Shell reloaded${NC}"
    else
        echo -e "${YELLOW}⚠ Could not reload automatically${NC}"
        echo "In VM: Press Alt+F2, type 'r', press Enter"
    fi
elif [ "$SESSION_TYPE" = "wayland" ]; then
    echo -e "${YELLOW}⚠ Wayland session detected${NC}"
    echo "You must log out and log back in to see changes."
    echo
    echo -e "${BLUE}Tip:${NC} Switch to X11 for faster development:"
    echo "  Log out → Click gear icon → Select 'GNOME on Xorg'"
else
    echo -e "${YELLOW}⚠ Could not detect session type${NC}"
    echo "To reload: Alt+F2 → 'r' (X11) or logout/login (Wayland)"
fi

echo
echo -e "${GREEN}✓ Extension installation complete${NC}"
