#!/bin/bash
#
# vm-setup - Full VM setup and configuration script
# Created by Cline (based on vm-install)
#
# This script handles the complete VM setup workflow:
# - Auto-detects running VMs (no config file needed)
# - Sets up SSH access if not configured
# - Installs SPICE packages if missing
# - Ensures shared folder is mounted
# - Creates extension symlink
# - Writes cache for fast vm-dev iterations
#
# Usage: ./vm-setup or 'make vm-setup'
#

set -e

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Source the shared VM detection library
source "$SCRIPT_DIR/lib/vm-detect.sh"

# Override cache file location with proper path
VM_CACHE_FILE="$PROJECT_DIR/.vm-cache"

# Extension details
EXTENSION_UUID="zoned@hamiltonia.me"

# ============================================
#  MAIN WORKFLOW
# ============================================

main() {
    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}   Zoned VM Setup${NC}"
    echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Step 1: Detect running VM
    vm_print_step "Detecting running VMs..."
    if ! vm_detect_target; then
        exit 1
    fi
    echo ""
    
    # Step 2: Ensure SSH access
    if ! vm_ensure_ssh; then
        exit 1
    fi
    echo ""
    
    # Step 3: Check/install SPICE packages (for shared folders)
    local spice_result
    vm_ensure_spice
    spice_result=$?
    
    if [[ $spice_result -eq 2 ]]; then
        # Reboot required
        exit 0
    elif [[ $spice_result -eq 1 ]]; then
        vm_print_warning "Continuing without SPICE packages (shared folders may not work)"
    fi
    echo ""
    
    # Step 4: Check shared folder mount
    if ! vm_detect_mount; then
        exit 1
    fi
    echo ""
    
    # Step 5: Check dependencies
    if ! vm_check_dependencies; then
        echo ""
        read -p "Install missing dependencies? [Y/n]: " confirm
        if [[ "${confirm,,}" != "n" ]]; then
            if ! vm_install_dependencies; then
                vm_print_error "Failed to install dependencies"
                exit 1
            fi
        else
            vm_print_warning "Continuing without all dependencies"
        fi
    fi
    echo ""
    
    # Step 6: Verify extension exists in shared folder
    vm_print_step "Verifying extension in shared folder..."
    if ! ssh "$VM_DOMAIN" "test -f $VM_MOUNT_PATH/extension/metadata.json" 2>/dev/null; then
        vm_print_error "Extension not found in shared folder"
        echo ""
        echo "Expected: $VM_MOUNT_PATH/extension/metadata.json"
        echo ""
        echo "Make sure:"
        echo "  1. The shared folder points to the zoned project directory"
        echo "  2. The folder is properly mounted in the VM"
        exit 1
    fi
    vm_print_success "Extension found"
    echo ""
    
    # Step 7: Create symlink if not exists
    vm_print_step "Setting up extension symlink..."
    local ext_dir="\$HOME/.local/share/gnome-shell/extensions/$EXTENSION_UUID"
    
    # Check if symlink already exists and points to correct location
    local current_link
    current_link=$(ssh "$VM_DOMAIN" "readlink $ext_dir 2>/dev/null" || echo "")
    
    if [[ "$current_link" == "$VM_MOUNT_PATH/extension" ]]; then
        vm_print_success "Symlink already configured"
    else
        # Remove existing directory/symlink if present
        ssh "$VM_DOMAIN" "rm -rf $ext_dir 2>/dev/null" || true
        
        # Create parent directory and symlink
        ssh "$VM_DOMAIN" "mkdir -p \$(dirname $ext_dir) && ln -sf $VM_MOUNT_PATH/extension $ext_dir"
        vm_print_success "Symlink created: $ext_dir → $VM_MOUNT_PATH/extension"
    fi
    echo ""
    
    # Step 8: Compile schema
    vm_print_step "Compiling GSettings schema..."
    if ssh "$VM_DOMAIN" "test -d $ext_dir/schemas" 2>/dev/null; then
        ssh "$VM_DOMAIN" "glib-compile-schemas $ext_dir/schemas/"
        vm_print_success "Schema compiled"
    else
        vm_print_warning "No schemas directory found"
    fi
    echo ""
    
    # Step 9: Enable extension if not enabled
    vm_print_step "Checking extension status..."
    local ext_state
    ext_state=$(ssh "$VM_DOMAIN" "gnome-extensions info $EXTENSION_UUID 2>/dev/null | grep 'State:'" 2>/dev/null || echo "State: UNKNOWN")
    
    if echo "$ext_state" | grep -qE 'State:\s*(ACTIVE|INACTIVE)'; then
        vm_print_success "Extension is enabled"
    else
        vm_print_info "Enabling extension..."
        ssh "$VM_DOMAIN" "gnome-extensions enable $EXTENSION_UUID" 2>/dev/null || true
        vm_print_success "Extension enabled"
    fi
    echo ""
    
    # Step 10: Write cache for fast vm-dev
    vm_print_step "Saving configuration..."
    vm_write_cache "$VM_CACHE_FILE"
    echo ""
    
    # Step 11: Reload GNOME Shell (X11 only)
    vm_print_step "Checking session type..."
    
    # Detect session type (must check graphical session, not SSH session)
    local session_type
    session_type=$(ssh "$VM_DOMAIN" "
        for sid in \$(loginctl --no-legend | awk '{print \$1}'); do
            type=\$(loginctl show-session \$sid -p Type --value 2>/dev/null)
            if [ \"\$type\" = 'x11' ] || [ \"\$type\" = 'wayland' ]; then
                echo \$type
                break
            fi
        done
    " 2>/dev/null || echo "")
    [[ -z "$session_type" ]] && session_type="unknown"
    
    echo ""
    if [[ "$session_type" == "x11" ]]; then
        vm_print_info "Session type: X11"
        vm_print_step "Reloading GNOME Shell..."
        
        if ssh "$VM_DOMAIN" "DISPLAY=:0 gdbus call --session --dest org.gnome.Shell --object-path /org/gnome/Shell --method org.gnome.Shell.Eval 'Meta.restart(\"Restarting…\")'" &>/dev/null; then
            vm_print_success "GNOME Shell reloaded"
        else
            vm_print_warning "Could not reload automatically"
            echo "  In VM: Press Alt+F2, type 'r', press Enter"
        fi
    elif [[ "$session_type" == "wayland" ]]; then
        vm_print_info "Session type: Wayland"
        vm_print_warning "Wayland cannot hot-reload GNOME Shell"
        echo ""
        echo "  To see changes: Log out and log back in"
        echo ""
        echo "  Tip: For faster development, switch to X11:"
        echo "    Log out → Click gear icon at login → Select 'GNOME on Xorg'"
    else
        vm_print_info "Session type: Unknown"
        echo "  To reload: Alt+F2 → 'r' (X11) or log out/in (Wayland)"
    fi
    
    echo ""
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}   ✓ VM setup complete!${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  VM: ${CYAN}$VM_DOMAIN${NC} ($VM_IP)"
    echo ""
    echo "  Next steps:"
    echo "    make vm-dev     - Fast deploy (use for iteration)"
    echo "    make vm-logs    - Watch extension logs"
    echo ""
}

main "$@"
