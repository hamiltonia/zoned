#!/bin/bash
#
# vm-install - VM deployment script
#
# This script provides fast iterative development:
# - Uses cached VM state from previous vm-setup
# - Copies extension files to writable VM directory
# - Compiles GSettings schema in writable location
# - Reloads GNOME Shell to apply changes
#
# Usage: ./vm-install or 'make vm-install'
#

set -e

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Source the shared VM detection library
source "$SCRIPT_DIR/../lib/vm-detect.sh"

# Override cache file location with proper path
VM_CACHE_FILE="$PROJECT_DIR/.vm-cache"

# Extension details
EXTENSION_UUID="zoned@hamiltonia.me"

# ============================================
#  MAIN WORKFLOW
# ============================================

main() {
    echo -e "${CYAN}▶ VM Deploy${NC}"
    echo ""
    
    # Step 1: Load cache
    if ! vm_read_cache "$VM_CACHE_FILE"; then
        vm_print_error "No VM cache found"
        echo ""
        echo "Run 'make vm-setup' first to configure your VM."
        exit 1
    fi
    
    # Report VM and share type
    if [[ "$VM_SHARE_TYPE" == "virtiofs" ]]; then
        vm_print_info "Using cached VM: ${CYAN}$VM_DOMAIN${NC} ${GREEN}(virtiofs)${NC}"
    else
        vm_print_info "Using cached VM: ${CYAN}$VM_DOMAIN${NC} ${YELLOW}(SPICE WebDAV)${NC}"
    fi
    
    # Step 2: Verify cache is still valid (VM running, SSH works)
    if ! vm_cache_is_valid; then
        vm_print_error "VM cache is stale"
        echo ""
        echo "The cached VM is not available. Run 'make vm-setup' to reconfigure."
        exit 1
    fi
    
    # Step 3: Copy extension files to writable directory
    vm_print_step "Installing extension files to VM..."
    local ext_dir="\$HOME/.local/share/gnome-shell/extensions/$EXTENSION_UUID"
    
    # Verify source files are accessible
    echo -e "${YELLOW}  [VM]${NC} Checking source files..."
    if ! ssh "$VM_DOMAIN" "test -f '$VM_MOUNT_PATH/extension/metadata.json'" 2>/dev/null; then
        vm_print_error "Extension source not found at $VM_MOUNT_PATH/extension"
        echo "Run './scripts/vm setup' first to configure your VM."
        exit 1
    fi
    
    # Create installation directory and copy files (remove old install first)
    echo -e "${YELLOW}  [VM]${NC} Removing old installation..."
    ssh "$VM_DOMAIN" "rm -rf $ext_dir" 2>/dev/null || true
    
    echo -e "${YELLOW}  [VM]${NC} Copying extension files..."
    if ! ssh "$VM_DOMAIN" "mkdir -p $ext_dir && cp -r '$VM_MOUNT_PATH/extension/'* $ext_dir/" 2>&1; then
        vm_print_error "Failed to copy extension files"
        exit 1
    fi
    
    echo -e "${YELLOW}  [VM]${NC} Verifying installation..."
    if ssh "$VM_DOMAIN" "test -f $ext_dir/metadata.json" 2>/dev/null; then
        vm_print_success "Extension files copied to writable directory"
    else
        vm_print_error "Extension copy verification failed"
        exit 1
    fi
    
    # Step 4: Compile schema in writable directory
    vm_print_step "Compiling GSettings schema..."
    
    echo -e "${YELLOW}  [VM]${NC} Checking for schemas directory..."
    if ssh "$VM_DOMAIN" "test -d $ext_dir/schemas" 2>/dev/null; then
        echo -e "${YELLOW}  [VM]${NC} Compiling GSettings schema..."
        ssh "$VM_DOMAIN" "glib-compile-schemas $ext_dir/schemas/" 2>/dev/null
        
        echo -e "${YELLOW}  [VM]${NC} Verifying schema compilation..."
        if ssh "$VM_DOMAIN" "test -f $ext_dir/schemas/gschemas.compiled" 2>/dev/null; then
            vm_print_success "Schema compiled successfully"
        else
            vm_print_error "Schema compilation failed"
            exit 1
        fi
    else
        vm_print_warning "No schemas directory found"
    fi
    
    # Step 5: Reload GNOME Shell
    vm_print_step "Reloading GNOME Shell..."
    
    # Detect session type
    echo -e "${YELLOW}  [VM]${NC} Detecting session type..."
    local session_type
    session_type=$(ssh "$VM_DOMAIN" "
        for sid in \$(loginctl --no-legend | awk '{print \$1}'); do
            type=\$(loginctl show-session \$sid -p Type --value 2>/dev/null)
            if [ \"\$type\" = 'x11' ] || [ \"\$type\" = 'wayland' ]; then
                echo \$type
                break
            fi
        done
    " 2>/dev/null || echo "")
    [[ -z "$session_type" ]] && session_type="unknown"
    
    if [[ "$session_type" == "x11" ]]; then
        echo -e "${YELLOW}  [VM]${NC} Restarting GNOME Shell (X11)..."
        if ssh "$VM_DOMAIN" "DISPLAY=:0 gdbus call --session --dest org.gnome.Shell --object-path /org/gnome/Shell --method org.gnome.Shell.Eval 'Meta.restart(\"Restarting…\")'" &>/dev/null; then
            vm_print_success "GNOME Shell reloaded"
        else
            vm_print_warning "Could not reload automatically"
            echo "  In VM: Press Alt+F2, type 'r', press Enter"
        fi
    elif [[ "$session_type" == "wayland" ]]; then
        vm_print_warning "Wayland: Log out and back in to see changes"
    else
        vm_print_info "Session type unknown - reload manually"
    fi
    
    echo ""
    vm_print_success "Deploy complete"
}

main "$@"
