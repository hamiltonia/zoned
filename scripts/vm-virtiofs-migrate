#!/bin/bash
# vm-virtiofs-migrate - Convert existing GNOME Boxes VM to use virtiofs
# This script adds virtiofs file sharing to an existing VM, replacing SPICE WebDAV
#
# Usage: ./scripts/vm-virtiofs-migrate
#
# The script will:
# 1. List available VMs and let you select one
# 2. Back up the current VM configuration
# 3. Add virtiofs configuration for sharing the zoned directory
# 4. Provide instructions for mounting inside the VM

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
LIBVIRT_URI="qemu:///session"
BACKUP_DIR="$HOME/.config/gnome-boxes/vm-backups"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_SHARE_PATH="$(dirname "$SCRIPT_DIR")"  # Parent of scripts/ dir (the zoned repo)
SHARE_NAME="zoned"
MOUNT_POINT="/mnt/zoned"

# Helper functions
info() { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }
prompt() { echo -en "${CYAN}?${NC} $1"; }

# Check prerequisites
check_prerequisites() {
    info "Checking prerequisites..."
    
    # Check virtiofsd
    if ! command -v virtiofsd &>/dev/null; then
        if [[ -x /usr/libexec/virtiofsd ]]; then
            success "virtiofsd found at /usr/libexec/virtiofsd"
        else
            error "virtiofsd not found. Install it with:
  Fedora:  sudo dnf install virtiofsd
  Ubuntu:  sudo apt install virtiofsd
  Arch:    sudo pacman -S virtiofsd"
        fi
    else
        success "virtiofsd is installed"
    fi
    
    # Check virsh
    if ! command -v virsh &>/dev/null; then
        error "virsh not found. Install libvirt tools."
    fi
    
    success "Prerequisites check passed"
    echo ""
}

# List available VMs
list_vms() {
    virsh -c "$LIBVIRT_URI" list --all --name 2>/dev/null | grep -v '^$'
}

# Get VM state
get_vm_state() {
    local vm_name="$1"
    virsh -c "$LIBVIRT_URI" domstate "$vm_name" 2>/dev/null
}

# Select VM
select_vm() {
    info "Available VMs:"
    echo ""
    
    local vms=()
    local i=1
    while IFS= read -r vm; do
        [[ -z "$vm" ]] && continue
        local state=$(get_vm_state "$vm")
        vms+=("$vm")
        printf "  ${CYAN}%d)${NC} %-30s [%s]\n" "$i" "$vm" "$state"
        ((i++))
    done < <(list_vms)
    
    if [[ ${#vms[@]} -eq 0 ]]; then
        error "No VMs found. Create a VM first using GNOME Boxes."
    fi
    
    echo ""
    prompt "Select VM number [1-${#vms[@]}]: "
    read -r selection
    
    if [[ ! "$selection" =~ ^[0-9]+$ ]] || [[ "$selection" -lt 1 ]] || [[ "$selection" -gt ${#vms[@]} ]]; then
        error "Invalid selection"
    fi
    
    SELECTED_VM="${vms[$((selection-1))]}"
    success "Selected: $SELECTED_VM"
    echo ""
}

# Check if VM is running and offer to shut down
check_vm_state() {
    local state=$(get_vm_state "$SELECTED_VM")
    
    if [[ "$state" == "running" ]]; then
        warn "VM '$SELECTED_VM' is currently running"
        prompt "Shut down VM to apply changes? [Y/n]: "
        read -r response
        
        if [[ "$response" != "n" && "$response" != "N" ]]; then
            info "Shutting down VM..."
            virsh -c "$LIBVIRT_URI" shutdown "$SELECTED_VM"
            
            # Wait for shutdown
            local timeout=60
            local elapsed=0
            while [[ $(get_vm_state "$SELECTED_VM") == "running" ]] && [[ $elapsed -lt $timeout ]]; do
                echo -n "."
                sleep 2
                ((elapsed+=2))
            done
            echo ""
            
            if [[ $(get_vm_state "$SELECTED_VM") == "running" ]]; then
                warn "VM didn't shut down gracefully. Force off?"
                prompt "Force power off? [y/N]: "
                read -r force
                if [[ "$force" == "y" || "$force" == "Y" ]]; then
                    virsh -c "$LIBVIRT_URI" destroy "$SELECTED_VM"
                else
                    error "Cannot modify running VM. Please shut it down manually."
                fi
            fi
            success "VM shutdown complete"
        else
            error "Cannot modify running VM"
        fi
    else
        success "VM is not running"
    fi
    echo ""
}

# Prompt for share path
configure_share_path() {
    info "Configure shared folder"
    echo "  Current directory: $DEFAULT_SHARE_PATH"
    echo ""
    prompt "Share path [$DEFAULT_SHARE_PATH]: "
    read -r custom_path
    
    if [[ -n "$custom_path" ]]; then
        SHARE_PATH="$custom_path"
    else
        SHARE_PATH="$DEFAULT_SHARE_PATH"
    fi
    
    # Verify path exists
    if [[ ! -d "$SHARE_PATH" ]]; then
        error "Path does not exist: $SHARE_PATH"
    fi
    
    success "Will share: $SHARE_PATH"
    echo ""
}

# Backup current VM configuration
backup_vm_xml() {
    info "Backing up VM configuration..."
    
    mkdir -p "$BACKUP_DIR"
    local backup_file="$BACKUP_DIR/${SELECTED_VM}_$(date +%Y%m%d_%H%M%S).xml"
    
    virsh -c "$LIBVIRT_URI" dumpxml "$SELECTED_VM" > "$backup_file"
    
    success "Backup saved to: $backup_file"
    BACKUP_FILE="$backup_file"
    echo ""
}

# Check if VM already has virtiofs configured
check_existing_virtiofs() {
    local xml=$(virsh -c "$LIBVIRT_URI" dumpxml "$SELECTED_VM")
    
    if echo "$xml" | grep -q "type='virtiofs'"; then
        warn "VM already has virtiofs configured"
        prompt "Reconfigure virtiofs? [y/N]: "
        read -r response
        if [[ "$response" != "y" && "$response" != "Y" ]]; then
            info "No changes made. VM is ready to use."
            show_guest_instructions
            exit 0
        fi
        RECONFIGURE=true
    else
        RECONFIGURE=false
    fi
}

# Add virtiofs configuration to VM
add_virtiofs_config() {
    info "Adding virtiofs configuration..."
    
    # Get current XML
    local xml_file=$(mktemp)
    virsh -c "$LIBVIRT_URI" dumpxml "$SELECTED_VM" > "$xml_file"
    
    # Check if memoryBacking already exists
    if grep -q "<memoryBacking>" "$xml_file"; then
        info "memoryBacking already configured"
    else
        # Add memoryBacking before </domain>
        sed -i 's|</domain>|  <memoryBacking>\n    <source type="memfd"/>\n    <access mode="shared"/>\n  </memoryBacking>\n</domain>|' "$xml_file"
        success "Added memoryBacking configuration"
    fi
    
    # Remove existing virtiofs filesystem if reconfiguring
    if [[ "$RECONFIGURE" == "true" ]]; then
        sed -i "/<filesystem type='mount' accessmode='passthrough'>/{:a;N;/<\/filesystem>/!ba;/virtiofs/d}" "$xml_file"
    fi
    
    # Add filesystem element inside <devices>
    # Find the closing </devices> tag and insert before it
    local fs_config="    <filesystem type='mount' accessmode='passthrough'>\n      <driver type='virtiofs'/>\n      <source dir='${SHARE_PATH}'/>\n      <target dir='${SHARE_NAME}'/>\n    </filesystem>"
    
    sed -i "s|</devices>|${fs_config}\n  </devices>|" "$xml_file"
    success "Added filesystem configuration"
    
    # Show the changes
    echo ""
    info "Configuration changes:"
    echo -e "${CYAN}───────────────────────────────────────${NC}"
    echo "  Memory backing: memfd + shared access"
    echo "  Filesystem type: virtiofs"
    echo "  Source dir: $SHARE_PATH"
    echo "  Target name: $SHARE_NAME"
    echo "  Mount point (guest): $MOUNT_POINT"
    echo -e "${CYAN}───────────────────────────────────────${NC}"
    echo ""
    
    prompt "Apply these changes? [Y/n]: "
    read -r response
    
    if [[ "$response" == "n" || "$response" == "N" ]]; then
        rm "$xml_file"
        error "Changes cancelled"
    fi
    
    # Apply the new configuration
    virsh -c "$LIBVIRT_URI" define "$xml_file"
    rm "$xml_file"
    
    success "VM configuration updated"
    echo ""
    
    # Fix permissions for virtiofs passthrough mode
    fix_virtiofs_permissions
}

# Fix file permissions for virtiofs passthrough mode
# virtiofs with passthrough preserves host UIDs/GIDs, which causes permission issues
# Make all files readable by all users (a+rX) to ensure VM user can access them
fix_virtiofs_permissions() {
    info "Fixing file permissions for virtiofs access..."
    echo ""
    echo "virtiofs uses passthrough mode which preserves host UIDs/GIDs."
    echo "Making shared files readable by all users to avoid permission issues."
    echo ""
    
    # Use find with chmod to make everything readable
    # -type d: directories get +rX (read + execute for traversal)
    # -type f: files get +r (read only)
    info "Setting permissions on: $SHARE_PATH"
    
    if chmod -R a+rX "$SHARE_PATH" 2>/dev/null; then
        success "Permissions updated successfully"
    else
        warn "Could not update some permissions (may need sudo)"
        prompt "Run with sudo to fix remaining permissions? [Y/n]: "
        read -r response
        
        if [[ "$response" != "n" && "$response" != "N" ]]; then
            sudo chmod -R a+rX "$SHARE_PATH"
            success "Permissions updated with sudo"
        else
            warn "Some files may not be accessible in VM"
            echo "  You can fix this manually later with:"
            echo "    chmod -R a+rX $SHARE_PATH"
        fi
    fi
    echo ""
}

# Offer to start VM
offer_start_vm() {
    prompt "Start VM now? [Y/n]: "
    read -r response
    
    if [[ "$response" != "n" && "$response" != "N" ]]; then
        info "Starting VM..."
        virsh -c "$LIBVIRT_URI" start "$SELECTED_VM"
        success "VM started"
        
        # Wait a moment for VM to begin booting
        sleep 2
    fi
    echo ""
}

# Show guest-side mount instructions
show_guest_instructions() {
    echo ""
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║              virtiofs Configuration Complete!                  ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "To complete setup, run these commands INSIDE the VM:"
    echo ""
    echo -e "${CYAN}# Create mount point${NC}"
    echo "  sudo mkdir -p $MOUNT_POINT"
    echo ""
    echo -e "${CYAN}# Mount virtiofs share${NC}"
    echo "  sudo mount -t virtiofs $SHARE_NAME $MOUNT_POINT"
    echo ""
    echo -e "${CYAN}# Make it permanent (add to fstab)${NC}"
    echo "  echo '$SHARE_NAME $MOUNT_POINT virtiofs defaults 0 0' | sudo tee -a /etc/fstab"
    echo ""
    echo -e "${CYAN}# Verify${NC}"
    echo "  ls $MOUNT_POINT/extension/"
    echo ""
    echo -e "${YELLOW}Note:${NC} You can remove SPICE shared folders from GNOME Boxes settings"
    echo "      since virtiofs replaces that functionality."
    echo ""
    
    if [[ -f "$BACKUP_FILE" ]]; then
        echo -e "${CYAN}Backup:${NC} $BACKUP_FILE"
        echo "  To restore: virsh -c $LIBVIRT_URI define $BACKUP_FILE"
        echo ""
    fi
}

# Main
main() {
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  VM virtiofs Migration Tool${NC}"
    echo -e "${GREEN}  Convert GNOME Boxes VM to use virtiofs file sharing${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    check_prerequisites
    select_vm
    check_vm_state
    configure_share_path
    backup_vm_xml
    check_existing_virtiofs
    add_virtiofs_config
    offer_start_vm
    show_guest_instructions
}

main "$@"
