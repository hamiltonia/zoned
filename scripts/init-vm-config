#!/bin/bash
#
# init-vm-config - Interactive VM development configuration wizard
# 
# Creates ~/.config/zoned-dev/config with VM connection details
# for use with other vm-* scripts.
#
# Also helps set up SSH config if needed.
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

CONFIG_DIR="$HOME/.config/zoned-dev"
CONFIG_FILE="$CONFIG_DIR/config"
SSH_CONFIG="$HOME/.ssh/config"

echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Zoned VM Development - Configuration Wizard${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
echo

# Check if config already exists
if [ -f "$CONFIG_FILE" ]; then
    echo -e "${YELLOW}⚠ Configuration file already exists: $CONFIG_FILE${NC}"
    read -p "Do you want to recreate it? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Configuration unchanged. Exiting.${NC}"
        exit 0
    fi
fi

echo "This wizard will help you set up VM development for Zoned."
echo "You'll need to have already created a VM in GNOME Boxes."
echo

# ════════════════════════════════════════════════════════════════════════════
# VM PREREQUISITES
# ════════════════════════════════════════════════════════════════════════════

echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}   VM Prerequisites${NC}"
echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
echo
echo "Before we can configure remote access, you need to run these"
echo "commands ${YELLOW}IN YOUR VM${NC} (not on this host):"
echo
echo -e "${GREEN}For Ubuntu/Debian:${NC}"
echo "  sudo apt update && sudo apt upgrade -y"
echo "  sudo apt install openssh-server -y"
echo "  sudo systemctl enable --now ssh"
echo "  ip addr show | grep 'inet '"
echo
echo -e "${GREEN}For Fedora:${NC}"
echo "  sudo dnf upgrade -y"
echo "  sudo dnf install openssh-server -y"
echo "  sudo systemctl enable --now sshd"
echo "  ip addr show | grep 'inet '"
echo
echo -e "${GREEN}For Arch:${NC}"
echo "  sudo pacman -Syu"
echo "  sudo pacman -S openssh"
echo "  sudo systemctl enable --now sshd"
echo "  ip addr show | grep 'inet '"
echo
echo -e "${YELLOW}Note the VM's IP address (looks like 192.168.122.xxx).${NC}"
echo
read -p "Press Enter when these steps are complete in the VM... "
echo

# ════════════════════════════════════════════════════════════════════════════
# SSH ALIAS CHECK AND SETUP
# ════════════════════════════════════════════════════════════════════════════

echo -e "${GREEN}Step 1: SSH Configuration${NC}"
echo
echo "Scanning for existing SSH hosts in ~/.ssh/config..."
echo

# Parse SSH config for existing hosts
declare -a SSH_HOSTS=()
declare -a SSH_HOSTNAMES=()
declare -a SSH_USERS=()

if [ -f "$SSH_CONFIG" ]; then
    current_host=""
    current_hostname=""
    current_user=""
    
    while IFS= read -r line || [ -n "$line" ]; do
        # Trim leading whitespace
        trimmed=$(echo "$line" | sed 's/^[[:space:]]*//')
        
        if [[ $trimmed =~ ^Host[[:space:]]+(.+)$ ]]; then
            # Save previous host if we have one
            if [ -n "$current_host" ] && [[ ! "$current_host" =~ [\*\?] ]]; then
                SSH_HOSTS+=("$current_host")
                SSH_HOSTNAMES+=("${current_hostname:-unknown}")
                SSH_USERS+=("${current_user:-$USER}")
            fi
            # Start new host
            current_host="${BASH_REMATCH[1]}"
            current_hostname=""
            current_user=""
        elif [[ $trimmed =~ ^HostName[[:space:]]+(.+)$ ]]; then
            current_hostname="${BASH_REMATCH[1]}"
        elif [[ $trimmed =~ ^User[[:space:]]+(.+)$ ]]; then
            current_user="${BASH_REMATCH[1]}"
        fi
    done < "$SSH_CONFIG"
    
    # Don't forget the last host
    if [ -n "$current_host" ] && [[ ! "$current_host" =~ [\*\?] ]]; then
        SSH_HOSTS+=("$current_host")
        SSH_HOSTNAMES+=("${current_hostname:-unknown}")
        SSH_USERS+=("${current_user:-$USER}")
    fi
fi

USE_EXISTING_HOST=false

if [ ${#SSH_HOSTS[@]} -gt 0 ]; then
    echo -e "${CYAN}Found ${#SSH_HOSTS[@]} SSH host alias(es):${NC}"
    echo
    for i in "${!SSH_HOSTS[@]}"; do
        num=$((i + 1))
        echo -e "  ${GREEN}[$num]${NC} ${SSH_HOSTS[$i]}  →  ${SSH_HOSTNAMES[$i]} (${SSH_USERS[$i]})"
    done
    echo
    echo -e "  ${YELLOW}[N]${NC} Create a new SSH alias"
    echo
    
    while true; do
        read -p "Select an option (1-${#SSH_HOSTS[@]} or N): " choice
        
        if [[ "$choice" =~ ^[Nn]$ ]]; then
            USE_EXISTING_HOST=false
            break
        elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#SSH_HOSTS[@]} ]; then
            idx=$((choice - 1))
            VM_HOST="${SSH_HOSTS[$idx]}"
            USE_EXISTING_HOST=true
            break
        else
            echo -e "${RED}Invalid choice. Enter 1-${#SSH_HOSTS[@]} or N${NC}"
        fi
    done
else
    echo -e "${YELLOW}No existing SSH aliases found in ~/.ssh/config${NC}"
    echo
    USE_EXISTING_HOST=false
fi

if [ "$USE_EXISTING_HOST" = true ]; then
    # User selected an existing SSH alias
    echo
    echo "Selected: $VM_HOST"
    echo "Testing connection..."
    
    if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "$VM_HOST" "exit" 2>/dev/null; then
        echo -e "${GREEN}✓ SSH connection successful${NC}"
        
        # Extract user and hostname from ssh -G
        VM_USER=$(ssh -G "$VM_HOST" 2>/dev/null | grep "^user " | head -1 | awk '{print $2}')
        VM_IP=$(ssh -G "$VM_HOST" 2>/dev/null | grep "^hostname " | head -1 | awk '{print $2}')
        
        echo "  User: $VM_USER"
        echo "  Host: $VM_IP"
    else
        echo -e "${YELLOW}⚠ Could not connect to $VM_HOST${NC}"
        echo "This might be OK if the VM isn't running or SSH keys aren't set up yet."
        echo
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
        
        # Extract from config since we can't connect
        VM_USER=$(ssh -G "$VM_HOST" 2>/dev/null | grep "^user " | head -1 | awk '{print $2}')
        VM_IP=$(ssh -G "$VM_HOST" 2>/dev/null | grep "^hostname " | head -1 | awk '{print $2}')
    fi
else
    # User needs to set up SSH alias - GUIDED SETUP
    echo
    echo -e "${CYAN}────────────────────────────────────────────────────────────${NC}"
    echo -e "${CYAN}   SSH Alias Setup${NC}"
    echo -e "${CYAN}────────────────────────────────────────────────────────────${NC}"
    echo
    echo "Let's set up an SSH alias for your VM. You'll need:"
    echo "  • The VM's IP address"
    echo "  • A name for the alias (e.g., 'fedora-vm')"
    echo
    
    # Get VM IP
    echo -e "${YELLOW}To find your VM's IP address:${NC}"
    echo "  1. Open a terminal in your VM"
    echo "  2. Run: ip addr show | grep 'inet ' | grep -v 127.0.0.1"
    echo "  3. Look for an IP like 192.168.122.xxx"
    echo
    read -p "Enter VM IP address: " VM_IP
    
    # Validate IP format
    if [[ ! $VM_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}✗ Invalid IP address format${NC}"
        exit 1
    fi
    
    # Get preferred alias name
    echo
    read -p "Enter preferred SSH alias name (default: fedora-vm): " VM_HOST
    VM_HOST=${VM_HOST:-fedora-vm}
    
    # Get username
    read -p "Enter VM username (default: $USER): " VM_USER
    VM_USER=${VM_USER:-$USER}
    
    # Create SSH config entry
    echo
    echo -e "${GREEN}Creating SSH configuration...${NC}"
    
    # Ensure .ssh directory exists
    mkdir -p "$HOME/.ssh"
    chmod 700 "$HOME/.ssh"
    
    # Check if alias already exists in ssh config
    if [ -f "$SSH_CONFIG" ] && grep -q "^Host $VM_HOST\$" "$SSH_CONFIG" 2>/dev/null; then
        echo -e "${YELLOW}⚠ Host '$VM_HOST' already exists in $SSH_CONFIG${NC}"
        read -p "Do you want to update it? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            # Remove old entry (everything from Host line to next Host or EOF)
            # Using a temp file for safety
            TEMP_CONFIG=$(mktemp)
            awk -v host="$VM_HOST" '
                /^Host / { 
                    if ($2 == host) { 
                        skip = 1; 
                        next 
                    } else { 
                        skip = 0 
                    } 
                }
                !skip { print }
            ' "$SSH_CONFIG" > "$TEMP_CONFIG"
            mv "$TEMP_CONFIG" "$SSH_CONFIG"
        else
            echo "Keeping existing SSH config entry."
        fi
    fi
    
    # Add new entry to SSH config
    echo -e "\n# Zoned development VM (added by init-vm-config)\nHost $VM_HOST\n    HostName $VM_IP\n    User $VM_USER\n    StrictHostKeyChecking no\n    UserKnownHostsFile /dev/null\n" >> "$SSH_CONFIG"
    
    chmod 600 "$SSH_CONFIG"
    echo -e "${GREEN}✓ SSH config entry added for '$VM_HOST'${NC}"
    echo
    
    # Offer to set up SSH keys
    echo -e "${CYAN}────────────────────────────────────────────────────────────${NC}"
    echo -e "${CYAN}   SSH Key Setup${NC}"
    echo -e "${CYAN}────────────────────────────────────────────────────────────${NC}"
    echo
    echo "For passwordless SSH (recommended for development), you need to copy"
    echo "your SSH public key to the VM."
    echo
    echo -e "${YELLOW}Prerequisites:${NC}"
    echo "  • SSH server must be installed in VM: sudo dnf install openssh-server"
    echo "  • SSH server must be running: sudo systemctl enable --now sshd"
    echo
    read -p "Would you like to copy your SSH key to the VM now? (Y/n): " -n 1 -r COPY_KEY
    echo
    
    if [[ ! $COPY_KEY =~ ^[Nn]$ ]]; then
        # Check if user has SSH keys
        if [ ! -f "$HOME/.ssh/id_rsa.pub" ] && [ ! -f "$HOME/.ssh/id_ed25519.pub" ]; then
            echo -e "${YELLOW}No SSH key found. Generating one...${NC}"
            ssh-keygen -t ed25519 -N "" -f "$HOME/.ssh/id_ed25519"
            echo -e "${GREEN}✓ SSH key generated${NC}"
        fi
        
        echo
        echo "Copying SSH key to $VM_HOST..."
        echo -e "${YELLOW}You may be prompted for your VM password.${NC}"
        echo
        
        if ssh-copy-id "$VM_HOST" 2>/dev/null; then
            echo -e "${GREEN}✓ SSH key copied successfully!${NC}"
        else
            echo -e "${YELLOW}⚠ Could not copy SSH key automatically.${NC}"
            echo
            echo "This is usually because:"
            echo "  • The VM isn't running"
            echo "  • SSH server isn't installed/running in the VM"
            echo "  • Wrong password entered"
            echo
            echo "You can copy the key later with: ssh-copy-id $VM_HOST"
        fi
    fi
    
    # Test connection
    echo
    echo -e "${GREEN}Step 2: Testing Connection${NC}"
    echo "Testing SSH connection to $VM_HOST..."
    
    if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "$VM_HOST" "exit" 2>/dev/null; then
        echo -e "${GREEN}✓ SSH connection successful (passwordless)${NC}"
    elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "$VM_HOST" "exit" 2>/dev/null; then
        echo -e "${YELLOW}✓ SSH connection works (password required)${NC}"
        echo "  You can set up passwordless auth later with: ssh-copy-id $VM_HOST"
    else
        echo -e "${YELLOW}⚠ Could not verify SSH connection${NC}"
        echo "  This is OK if the VM isn't currently running."
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

# Validate IP if we have one
if [ -n "$VM_IP" ] && [[ ! $VM_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo -e "${RED}✗ Invalid IP address format${NC}"
    exit 1
fi

# Extension UUID
EXTENSION_UUID="zoned@hamiltonia.me"

# Project directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Load distro detection library
if [ -f "$SCRIPT_DIR/lib/distro-detect.sh" ]; then
    source "$SCRIPT_DIR/lib/distro-detect.sh"
fi

# Detect hypervisor type based on host OS
echo
if [[ "$(uname)" == "Darwin" ]]; then
    echo -e "${BLUE}Detected macOS host - configuring for Parallels Desktop${NC}"
    VM_MOUNT_TYPE="parallels"
    VM_SPICE_MOUNT="/media/psf/zoned"
else
    echo -e "${BLUE}Detected Linux host - configuring for GNOME Boxes${NC}"
    VM_MOUNT_TYPE="gnome-boxes"
    VM_SPICE_MOUNT="/run/user/1000/spice-client-folder"
fi

# ════════════════════════════════════════════════════════════════════════════
# SPICE SHARED FOLDER SETUP (Linux/GNOME Boxes only)
# ════════════════════════════════════════════════════════════════════════════

if [[ "$VM_MOUNT_TYPE" == "gnome-boxes" ]]; then
    echo
    echo -e "${GREEN}Step 3: VM Shared Folder Support${NC}"
    echo
    echo "Checking if SPICE shared folder packages are installed in the VM..."
    
    # Test if we can connect to VM
    if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "$VM_HOST" "exit" 2>/dev/null; then
        SSH_WORKS=true
    elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "$VM_HOST" "exit" 2>/dev/null; then
        SSH_WORKS=true
    else
        SSH_WORKS=false
    fi
    
    if [ "$SSH_WORKS" = true ]; then
        # Detect guest distro
        if type detect_guest_distro &>/dev/null; then
            GUEST_DISTRO=$(detect_guest_distro "$VM_HOST")
        else
            GUEST_DISTRO=$(ssh "$VM_HOST" "if [ -f /etc/os-release ]; then . /etc/os-release; echo \$ID; else echo unknown; fi" 2>/dev/null || echo "unknown")
        fi
        
        echo "  Guest OS detected: $GUEST_DISTRO"
        
        # Check if spice-webdavd is installed
        SPICE_INSTALLED=$(ssh "$VM_HOST" "command -v /usr/sbin/spice-webdavd || command -v spice-webdavd" 2>/dev/null || echo "")
        
        if [ -n "$SPICE_INSTALLED" ]; then
            echo -e "${GREEN}✓ SPICE packages already installed${NC}"
            
            # Check if service is running (check both system and user service)
            SPICE_RUNNING_SYSTEM=$(ssh "$VM_HOST" "systemctl is-active spice-webdavd 2>/dev/null" || echo "inactive")
            SPICE_RUNNING_USER=$(ssh "$VM_HOST" "systemctl --user is-active spice-webdavd 2>/dev/null" || echo "inactive")
            
            if [ "$SPICE_RUNNING_SYSTEM" = "active" ]; then
                echo -e "${GREEN}✓ spice-webdavd service is running (system)${NC}"
            elif [ "$SPICE_RUNNING_USER" = "active" ]; then
                echo -e "${GREEN}✓ spice-webdavd service is running (user)${NC}"
            else
                echo -e "${YELLOW}⚠ spice-webdavd service is not running${NC}"
                read -p "Would you like to try starting it? (Y/n): " -n 1 -r START_SPICE
                echo
                if [[ ! $START_SPICE =~ ^[Nn]$ ]]; then
                    # Try system service first (Ubuntu), then user service (Fedora)
                    ssh "$VM_HOST" "sudo systemctl enable spice-webdavd 2>/dev/null; sudo systemctl start spice-webdavd 2>/dev/null" || \
                    ssh "$VM_HOST" "systemctl --user enable spice-webdavd 2>/dev/null; systemctl --user start spice-webdavd 2>/dev/null" || true
                    echo -e "${GREEN}✓ spice-webdavd service started${NC}"
                fi
            fi
        else
            echo -e "${YELLOW}⚠ SPICE shared folder packages not installed in VM${NC}"
            echo
            echo "These packages are required for shared folders to work with GNOME Boxes."
            echo
            read -p "Would you like to install them now? (Y/n): " -n 1 -r INSTALL_SPICE
            echo
            
            if [[ ! $INSTALL_SPICE =~ ^[Nn]$ ]]; then
                echo
                echo "Installing SPICE packages in VM..."
                echo -e "${YELLOW}You may be prompted for your VM password (sudo).${NC}"
                echo
                
                case "$GUEST_DISTRO" in
                    ubuntu|debian|pop)
                        echo "Installing SPICE + Extension development tools..."
                        echo "  - spice-vdagent spice-webdavd gvfs-backends (shared folders)"
                        echo "  - gnome-shell-extension-prefs (Extensions app)"
                        echo "  - gnome-shell-extension-manager (Extension Manager)"
                        ssh -t "$VM_HOST" "sudo apt update && sudo apt install -y spice-vdagent spice-webdavd gvfs-backends gnome-shell-extension-prefs gnome-shell-extension-manager"
                        ;;
                    fedora)
                        echo "Installing SPICE + Extension development tools..."
                        echo "  - spice-vdagent spice-webdavd (shared folders)"
                        echo "  - gnome-extensions-app (Extensions app)"
                        ssh -t "$VM_HOST" "sudo dnf install -y spice-vdagent spice-webdavd gnome-extensions-app"
                        ;;
                    arch|endeavouros|manjaro)
                        echo "Installing SPICE + Extension development tools..."
                        echo "  - spice-vdagent (shared folders)"
                        echo "  - gnome-shell-extensions (extension tools)"
                        ssh -t "$VM_HOST" "sudo pacman -S --noconfirm spice-vdagent gnome-shell-extensions"
                        ;;
                    opensuse*|suse*)
                        echo "Installing SPICE + Extension development tools..."
                        echo "  - spice-vdagent spice-webdavd (shared folders)"
                        ssh -t "$VM_HOST" "sudo zypper install -y spice-vdagent spice-webdavd"
                        ;;
                    *)
                        echo -e "${YELLOW}Unknown distro '$GUEST_DISTRO' - please install spice-vdagent and spice-webdavd manually${NC}"
                        ;;
                esac
                
                echo
                echo "Enabling spice-webdavd service..."
                ssh "$VM_HOST" "systemctl --user enable spice-webdavd 2>/dev/null; systemctl --user start spice-webdavd 2>/dev/null" || true
                
                echo
                echo -e "${GREEN}✓ SPICE packages installed${NC}"
                echo
                echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
                echo -e "${RED}   REBOOT REQUIRED${NC}"
                echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
                echo -e "${YELLOW}You MUST restart the VM for shared folders to work.${NC}"
                echo -e "${YELLOW}The 'Spice client folder' won't appear in Networks until after reboot.${NC}"
                echo
            fi
        fi
    else
        echo -e "${YELLOW}⚠ Cannot connect to VM - skipping SPICE setup${NC}"
        echo "  You can install SPICE packages manually later. In the VM, run:"
        echo
        echo "  # For Ubuntu/Debian:"
        echo "  sudo apt install spice-vdagent spice-webdavd gvfs-backends"
        echo
        echo "  # For Fedora:"
        echo "  sudo dnf install spice-vdagent spice-webdavd"
        echo
        echo "  # Then enable the service:"
        echo "  systemctl --user enable --now spice-webdavd"
    fi
fi

# ════════════════════════════════════════════════════════════════════════════
# CREATE CONFIG FILE
# ════════════════════════════════════════════════════════════════════════════

# Create config directory
mkdir -p "$CONFIG_DIR"

# Write configuration file
cat > "$CONFIG_FILE" << EOF
# Zoned VM Development Configuration
# Generated: $(date)

# VM connection details
VM_HOST="$VM_HOST"
VM_USER="$VM_USER"
VM_IP="$VM_IP"

# Project paths
HOST_PROJECT_DIR="$PROJECT_DIR"
VM_SPICE_MOUNT="$VM_SPICE_MOUNT"

# Hypervisor type
VM_MOUNT_TYPE="$VM_MOUNT_TYPE"

# Extension details
EXTENSION_UUID="$EXTENSION_UUID"
EOF

echo
echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✓ Configuration created successfully!${NC}"
echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
echo
echo "Configuration saved to: $CONFIG_FILE"
echo
echo -e "${BLUE}Summary:${NC}"
echo "  SSH alias:  $VM_HOST"
echo "  VM user:    $VM_USER"
echo "  VM IP:      ${VM_IP:-"(extracted from SSH config)"}"
echo "  Hypervisor: $VM_MOUNT_TYPE"
echo
echo -e "${BLUE}Next steps:${NC}"
if [[ "$VM_MOUNT_TYPE" == "parallels" ]]; then
    echo "  1. Configure shared folder in Parallels Desktop:"
    echo "     - Parallels Desktop → VM Configuration → Options → Sharing"
    echo "     - Enable 'Share Mac folders with Linux'"
    echo "     - Add custom folder: $PROJECT_DIR → Name: zoned"
    echo "     - In VM, verify: ls /media/psf/zoned"
else
    echo "  1. Configure shared folder in GNOME Boxes:"
    echo "     - Right-click VM → Properties → Devices & Shares"
    echo "     - Add shared folder: $PROJECT_DIR"
    echo "     - Share name: zoned"
    echo "     - In VM, open file manager → Other Locations → Networks"
    echo "     - Click 'Spice client folder' to mount it"
fi
echo
echo "  2. Run: make vm-setup"
echo "     (This will configure the VM for development)"
echo
