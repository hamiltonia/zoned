name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint (strict mode)
        run: npm run lint -- --max-warnings 0
        
      - name: Validate metadata.json structure
        run: |
          echo "Checking required metadata fields..."
          jq -e '.uuid' extension/metadata.json > /dev/null
          jq -e '.name' extension/metadata.json > /dev/null
          jq -e '.description' extension/metadata.json > /dev/null
          jq -e '.version' extension/metadata.json > /dev/null
          jq -e '."shell-version"' extension/metadata.json > /dev/null
          jq -e '.url' extension/metadata.json > /dev/null
          echo "✓ All required fields present"
          
      - name: Install GLib tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev-bin
          
      - name: Compile GSettings schema
        run: |
          echo "Compiling schema..."
          glib-compile-schemas extension/schemas/
          echo "✓ Schema compiled successfully"
          
      - name: Verify schema compiled
        run: |
          if [ ! -f extension/schemas/gschemas.compiled ]; then
            echo "Error: Schema compilation failed"
            exit 1
          fi
          echo "✓ Compiled schema exists"
          
      - name: Security checks
        run: |
          echo "Running security pattern checks..."
          
          # Check for dangerous eval patterns
          if grep -r "eval(" extension/ --include="*.js" 2>/dev/null; then
            echo "Error: Found eval() usage"
            exit 1
          fi
          
          # Check for Function constructor
          if grep -r "Function(" extension/ --include="*.js" 2>/dev/null; then
            echo "Error: Found Function() constructor"
            exit 1
          fi
          
          # Check for child_process/exec (GJS equivalent would be Gio.Subprocess with shell)
          if grep -r "Gio.Subprocess.new.*SHELL" extension/ --include="*.js" 2>/dev/null; then
            echo "Warning: Found shell subprocess execution"
          fi
          
          echo "✓ Security checks passed"
          
      - name: Check for deprecated GNOME Shell APIs
        run: |
          echo "Checking for deprecated API usage..."
          
          # Clutter deprecated methods
          if grep -r "show_all\|hide_all" extension/ --include="*.js" 2>/dev/null; then
            echo "Warning: Found potentially deprecated Clutter methods"
          fi
          
          # Old import style (extensions should use ESM)
          if grep -r "const.*=.*imports\." extension/ --include="*.js" 2>/dev/null; then
            echo "Warning: Found old-style imports (should use ESM import/export)"
          fi
          
          echo "✓ Deprecated API check complete"
          
      - name: Validate required files exist
        run: |
          echo "Checking required extension files..."
          
          required_files=(
            "extension/extension.js"
            "extension/metadata.json"
            "extension/schemas/org.gnome.shell.extensions.zoned.gschema.xml"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file missing: $file"
              exit 1
            fi
            echo "✓ $file"
          done
          
          echo "✓ All required files present"
