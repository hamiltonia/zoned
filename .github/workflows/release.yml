name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  ci:
    uses: ./.github/workflows/ci.yml
    
  build-and-release:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev-bin zip
        
      - name: Build extension package
        run: make build
        
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Try to extract changelog section for this version
          if [ -f CHANGELOG.md ]; then
            # Look for version header and capture until next version or end
            CHANGELOG_SECTION=$(awk "/^## \[?$VERSION\]?/,/^## \[?[0-9]/" CHANGELOG.md | sed '$d' || echo "")
            
            if [ -z "$CHANGELOG_SECTION" ]; then
              CHANGELOG_SECTION="See CHANGELOG.md for details."
            fi
            
            # Write to file to handle multiline
            echo "$CHANGELOG_SECTION" > /tmp/changelog.txt
          else
            echo "See commit history for changes." > /tmp/changelog.txt
          fi
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            build/zoned@hamiltonia.me.zip
          body_path: /tmp/changelog.txt
          fail_on_unmatched_files: true
          name: "Release ${{ steps.version.outputs.VERSION }}"
          
      - name: Release created
        run: |
          echo "âœ“ Draft release created successfully!"
          echo ""
          echo "Next steps:"
          echo "1. Go to GitHub Releases page"
          echo "2. Review the draft release"
          echo "3. Verify VM integration tests passed"
          echo "4. Edit release notes if needed"
          echo "5. Publish the release"
          echo "6. Download the zip and submit to extensions.gnome.org"
